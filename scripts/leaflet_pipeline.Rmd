---
title: "leaflet_pipeline"
author: "Sophia Kleist Karlson"
date: "18/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Load the sf package
pacman::p_load(pacman, tidyverse, dplyr, sf, leaflet, stringr, htmlwidgets, raster)

# set wd
setwd("~/Spatial analytics/project - queer travel map/lgbt-travel-map")

# load data
test_data <- st_read("data/test_data.shp")

# plot the points (don't know why it only shows 6)
plot(st_geometry(test_data))

# look at the coordinates
test_data["geometry"]

# check the crs
st_crs(test_data)

# when looking at the first map (by running the next code chunk without the last bit of this chunk) the points were not at the right place - maybe 100 meters to the north east. I also got this error message:
#sf layer has inconsistent datum (+proj=longlat +ellps=intl +towgs84=-86,-98,-119,0,0,0,0 +no_defs).
#Need '+proj=longlat +datum=WGS84' 

# Therefore, I re-projected the test data to the crs recommended in the error message above, and it worked!
crs_needed <- "+proj=longlat +datum=WGS84"
safespace_crs <- st_transform(test_data, crs = crs_needed)
```


Final map (still in progress)
```{r}
# define esri
esri <- grep("^Esri", providers, value = TRUE)

# make map
test_map <- leaflet() %>%
  addTiles() %>% # insert this in the parenthesis: attribution = 'By Rebecca Schade and Sophia Karlson'
  addControl("Queer Travel Map", position = "topleft", className="map-title") %>% # make this bigger!
  addProviderTiles("Esri.WorldTopoMap", group = "Topographic") %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  addCircleMarkers(data = safespace_crs,
                   opacity = 0.5, color = "black", stroke = TRUE,
                   fillOpacity = 0.5, weight=2, fillColor = "purple",
                   popup = paste0("Name: ", test_data$name,
                                  "<br> Type: ", test_data$amenity,
                                  "<br> Website: ", test_data$website,
                                  "<br> Opening hours: ", test_data$opnng_h), #,
                                  # if we had the data, these could be added as well:
                                  #"<br> Address: ", test_data$address),
                                  # who it is for (only men, everyone etc)
                   group = "Safe spaces",#if we don't want the user to be able to not see all the safe spaces, cut this
                  #) %>%
                   clusterOptions = markerClusterOptions()) %>%
  
  # add density overlay here
  
  # do the control stuff
  addLayersControl(
    baseGroups = c("Topographic","Aerial"),
    overlayGroups = c("Safe spaces", "Safe space density"),
    options = layersControlOptions(collapsed = T))
  
test_map

# save map
saveWidget(test_map, "test_map.html", selfcontained = TRUE)
```



Test map w. extra overlays
```{r}
#### for the first overlay with the inscriptions:

cities <- as.data.frame(read_csv("http://oxrep.classics.ox.ac.uk/oxrep/docs/Hanson2016/Hanson2016_Cities_OxREP.csv"))

# Convert the table into an sf object on the basis of X and Y columns
cities_sf <- st_as_sf(cities, coords = c("Longitude (X)", "Latitude (Y)")) # used the function st_as_sf()

plot(cities_sf)

# Define the projection of Lat/Long coordinates as EPSG 4326
cities_sf4326<- st_set_crs(cities_sf, "+proj=longlat +datum=WGS84") # inserted the ESPG value 4326

# Transform the projection to a 2D projection using EPSG 3035
cities_sf3035<- st_transform(cities_sf4326, "+proj=longlat +datum=WGS84") # set crs equal to the ESPG value 3035

# Verify the projection is 'projected' not 'geographic'
st_crs(cities_sf3035) # used the function crs() to check that the projection is indeed "projected" and not "geographic"


#### For convex hull overlay
#Make buffer of 5 km. Check the units of your object to correctly assign value to dist
safe_space_1km<- st_buffer(st_geometry(safespace_crs), dist = 0.1) # I use the object cities_sf3035 and set the distance to 5000, as I assume the radius measured in meters
plot(safe_space_1km)

# make convex hull around the safe spaces
safe_ch <- st_convex_hull(st_union(safespace_crs))
plot(safe_ch)
class(safe_ch)
st_crs(safe_ch)


#### for the raster overlay
#Aster <- raster("data/Aster.tif")
#crs(Aster)

#crs(Aster) <- "+proj=longlat +datum=WGS84" 
#plot(Aster)



#### map it
test_map_1 <- leaflet() %>%
  addTiles() %>% 
  addControl("Queer Travel Map", position = "topleft", className="map-title") %>% 
  addProviderTiles("Esri.WorldTopoMap", group = "Topographic") %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  
  # first overlay:
  addCircleMarkers(data = safespace_crs,
                   opacity = 0.5, color = "black", stroke = TRUE,
                   fillOpacity = 0.5, weight=2, fillColor = "purple",
                   popup = paste0("Name: ", test_data$name,
                                  "<br> Type: ", test_data$amenity,
                                  "<br> Website: ", test_data$website,
                                  "<br> Opening hours: ", test_data$opnng_h),
                   group = "Safe spaces",
                   clusterOptions = markerClusterOptions()) %>%
  
  # extra test overlay - markers:
  addCircleMarkers(data = cities_sf3035,
                   opacity = 0.5, color = "black", stroke = TRUE,
                   fillOpacity = 0.5, weight=2, fillColor = "purple", 
                   group = "More safe spaces",
                   clusterOptions = markerClusterOptions()) %>%
  
  # add overlay - e.g. polygon like here:
  addPolygons(data = safe_ch,
              fill = T, weight = 2, color = "purple",
              popup = paste0("Name: ", "gayboorhood-name"), 
              group = "Safe space density") %>%
  
  # add heatmap
  #addRasterImage(Aster) %>% 
  # it doesn't recognize the addHeatmap() function, so it's probably in a package
  #addHeatmap(map, lng = NULL, lat = NULL, intensity = NULL,
  #layerId = NULL, group = NULL, minOpacity = 0.05, max = 1,
  #radius = 25, blur = 15, gradient = NULL, cellSize = NULL,
  #data = leaflet::getMapData(map)) %>% 

  # add control things
  addLayersControl(
    baseGroups = c("Topographic","Aerial"),
    overlayGroups = c("Safe spaces", "More safe spaces", "Safe space density"),
    options = layersControlOptions(collapsed = T))
  
test_map_1
saveWidget(test_map_1, "test_map_1.html", selfcontained = TRUE)
```



find location feature
```{r}
library(shiny)
library(leaflet)

ui <- fluidPage(leafletOutput("map"))


server <- function(input, output, session) {

  output$map <- renderLeaflet({
    leaflet() %>%
      addTiles() %>% # insert this in the parenthesis: attribution = 'By Rebecca Schade and Sophia Karlson'
      addControl("Queer Travel Map", position = "topleft", className="map-title") %>% # make this bigger!
      addProviderTiles("Esri.WorldTopoMap", group = "Topographic") %>%
      addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
      addCircleMarkers(data = safespace_crs,
                       opacity = 0.5, color = "black", stroke = TRUE,
                       fillOpacity = 0.5, weight=2, fillColor = "purple",
                       popup = paste0("Name: ", test_data$name,
                                      "<br> Type: ", test_data$amenity,
                                      "<br> Website: ", test_data$website,
                                      "<br> Opening hours: ", test_data$opnng_h), #,
                                      # if we had the data, these could be added as well:
                                      #"<br> Address: ", test_data$address),
                                      # who it is for (only men, everyone etc)
                       group = "Safe spaces",#if we don't want the user to be able to not see all the safe spaces, cut this
                      #) %>%
                       clusterOptions = markerClusterOptions()) %>%
      
      # add density overlay here - e.g. polygons like here:
      addPolygons(data = safe_ch,
                  fill = T, weight = 2, color = "purple",
                  popup = paste0("Name: ", "gayboorhood-name"), 
                  group = "Safe space density") %>%
      
      # do the control stuff
      addLayersControl(
        baseGroups = c("Topographic","Aerial"),
        overlayGroups = c("Safe spaces", "Safe space density"),
        options = layersControlOptions(collapsed = T)) %>% 

    #leaflet() %>%
     # addProviderTiles(providers$Stamen.TonerLite,
      #                 options = providerTileOptions(noWrap = TRUE)) %>%

      addEasyButton(
        easyButton(
          position = "topleft",
          icon = "fa-crosshairs",
          title = "Locate Me",
          onClick = JS(
            c(
              "function(btn,  map){map.locate({setView:true,enableHighAccuracy: true })}"
            )
          )
        )
      )
  })

  observeEvent(input$map_bounds, {
    event <- input$map_bounds

    lat <- mean(event$north, event$south)
    lon <- mean(event$west, event$east)

    print(paste0("map center - lat: ", lat, ", lon: ", lon))

  })
}

shinyApp(ui,server)
```



To do:
- make density overlay - as convex hulls around areas with more than x points in y radius from eachother
- how to add overlay and do the groups thing: https://rstudio.github.io/leaflet/showhide.html 
- add legend (but that depends on the kind of density map)

try out bounding boxes

for later: 
- add legend
- better title
- fix NA's? 



TEST STUFF

```{r}

# other things to maybe add:
  #addMiniMap(tiles = esri[[1]], toggleDisplay = TRUE,
   #          position = "bottomright"))

  #addLegend("bottomright", pal = pal, values = ~gdp_md_est,
   #   title = "Safe spaces",
    #  labFormat = labelFormat(prefix = "$"),
     # opacity = 1
    #))
    

tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 28px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("Map title")
)  

rr <- tags$div(
   HTML('<a href="https://cran.r-project.org/"> <img border="0" alt="ImageTitle" src="/PathToImage/ImageR.jpeg" width="300" height="100"> </a>')
 )  

```


```{r}
# test europe with Layers
leaflet() %>% 
  addTiles() %>% 
  setView( lng = 12.57, lat = 55.68, zoom = 5 ) %>% # view set to cosy bar in CPH
  addProviderTiles("Esri.WorldPhysical", group = "Physical") %>% 
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>% 
  addProviderTiles("MtbMap", group = "Geo") %>% 

addLayersControl(
  baseGroups = c("Geo","Aerial", "Physical"),
  options = layersControlOptions(collapsed = T))


plot(test_data$geometry, pch = 2)
```

```{r}
coor <- test_data$geometry

coor

longitude <- c()

for (i in test_data){
  longitude <- str_replace_all(test_data$geometry, "c(|,[:digit:])", "'")
} 
  
test_data$longitude <- str_replace_all(test_data$geometry, "c\\(| |\\)", "")


test_data$longitude <- str_replace_all(test_data$longitude, "[[:alnum:]\\.],", "")

```
[:digit:].[:digit:]
[:xdigit:].[:xdigit:]


```{r}
# Make buffer of 5 km. Check the units of your object to correctly assign value to dist
safe_space_1km<- st_buffer(st_geometry(safespace_crs), dist = 0.1) # I use the object cities_sf3035 and set the distance to 5000, as I assume the radius measured in meters
plot(safe_space_1km)


safe_ch <- st_convex_hull(st_union(safespace_crs))
plot(safe_ch)
class(safe_ch)

st_crs(safe_ch)
st_crs(safe_space_1km)

safe_it <- st_intersection(safe_ch, safe_space_1km$geometry) # I use the geometry of safe_space_1km

??st_intersection()

# Dissolve the buffers into a single MULTIPOLYGON buffer feature
safe_buff <- st_union(safe_it)



c_buff <- st_transform(c_buff, crs = "+proj=longlat +datum=WGS84")

```

```{r}
library(shiny)
library(leaflet)

ui <- fluidPage(leafletOutput("map"))


server <- function(input, output, session) {

 output$map <- renderLeaflet({
 leaflet() %>%
  addProviderTiles(providers$Stamen.TonerLite,
                   options = providerTileOptions(noWrap = TRUE)) %>%

  addEasyButton(
    easyButton(
      position = "topleft",
      icon = "fa-crosshairs",
      title = "Locate Me",
      onClick = JS(
        c(
          "function(btn,  map){map.locate({setView:true,enableHighAccuracy: true })}"
        )
      )
    )
      )
  })
}

shinyApp(ui,server)
```



---
title: "Cluster analysis"
author: "Rebecca Folmer Schade & Sophia Kleist Karlson"
date: "2021-06-02 updated "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "..")
```

## Loading packages

```{r, , results='hide', warning=FALSE, error=FALSE, message=FALSE}
# Quick install/load of all used packages if needed 
# install.packages("pacman")
# pacman::p_load(pacman, sf, raster, tidyverse, spatstat, maptools)
library(sf)
library(raster)
library(tidyverse)
library(spatstat)
library(maptools)
```

# Loading data 

```{r, results='hide', warning=FALSE, message=FALSE, error=FALSE}
# load data
EEA_points <- st_read("data/EEA_points.shp")
```

### Converting to ppp

```{r}
#=====> Creating a convex hull to use as a window for analysis 
# Converting points to a single multi-point
multi_points <- st_union(EEA_points)

# Computing the convex hull 
points_hull <- st_convex_hull(multi_points)

# Ploting the points together with the hull
plot(points_hull, col = "red"); plot(st_geometry(multi_points), add = TRUE)

# Turning kaz_mounds into a ppp object
points_pre_p <- as.ppp(EEA_points)

# Turning the convex hull into a window
points_window <- as.owin(points_hull)

# Adding the window to the ppp object 
points_p <-ppp(points_pre_p$x, points_pre_p$y, window=points_window)

# plotting a square window against the convex hull widow to compare.
plot(points_pre_p);plot(points_p)

```

### Running quadrat test
A clustered distribution is the alternative hypothesis. 

```{r}
# Running the quadrant test
qt <- quadrat.test(points_p, alternative = "clustered")

# Inspect the results
plot(qt)
print(qt)
```
The test is significant at p < 0.05. This, coupled with the high X2 value, indicates that the null hypothesis (i.e. that the points are randomly distributed) is wrong and that the alternative hypothesis (i.e. that the points are clustered) is true.

There was, however, a warning message that the chi-square approximation may not be accurate. 

### Applying G function 

```{r}
# Estimating G(r) with the correction argument as "border" for edge correction.  
points_g <- Gest(points_p, correction = "border")

# Plotting G(r) vs. r
plot(points_g)
```

The black line (which shows the G score at the distance r) deviates quite a bit from the red line (the expected g scores in a random poisson distribution), which show that the distribution of points is quite different from a random one. A G(r) is cumulative probability, the steep slope at the smaller distances of the chart indicates that the probability of finding a nearest neighbor to the mounds close-by is higher than finding it farther away.  

### Applying K function 

```{r}
# Estimating the K-function with the correction argument as "border" for edge correction.  
points_k <- Kest(points_p, correction = "border")

# Plotting the K-function
plot(points_k)

# Computing envelopes of K 
k_env <- envelope(points_p, Kest, correction = "border")

# Plotting the K-function with the envelope and the ". - pi * r ^ 2 ~ r" formula to center the funtion of the expected K-function for a random poisson distribution for easier comparison. 
plot(k_env, . - pi * r ^ 2 ~ r)
```

The black line of the K-function (which represents the number of mounds within distance r, scaled by intensity) indicates that the points in this dataset are ususally close to each-other, rather than far away from each other. That the deviance from the red line (which represents the exprected K-function for a random poisson distribution) goes outside the envelope (represented by the grey area) indicates that these deviances are prevelant enough that they could not be attributed to statistical noise. 

## Conclutions

Given that the results of all three test (quadrat test, G-function, and K-function) seem to confirm each other, as well as the theoretical assumption detail pre-testing, it is likely that the points in this dataset are, indeed, clustered. 
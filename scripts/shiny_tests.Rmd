---
title: "shiny_experiments"
author: "Sophia Kleist Karlson"
date: "29/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Shiny - find location and nearest safe space feature

UI: user interface
widget: an application, or a component of an interface, that enables a user to perform a function or access a service
```{r}
library(shiny)
library(leaflet)

#https://www.rdocumentation.org/packages/leaflet/versions/2.0.4.1/topics/leafletOutput
#UI is the user interface. the "map" is the outputId, which is the "output variable to read from"
ui <- fluidPage(
  titlePanel("LGBTQ+ Travel Map"), 
  leafletOutput("map"))#, 
  #p(),
  # below, "map_center" is the name of the widget, that we define https://shiny.rstudio.com/tutorial/written-tutorial/lesson3/
  #actionButton("recalc", label = "Find my nearest safe space")) #("", find_my_location"Find my nearest safe space")) 


server <- function(input, output, session) {

  #print(home_point)
  # get the coordinates from the center and print them
  center_coor <- observeEvent(input$map_center, {#input$map_bounds, { #observeEvent
    event <- input$map_center#bounds
    lat <- event$lat
    lon <- event$lng
    print(cbind(lat, lon))
    #lat <- mean(event$north, event$south)
    #lon <- mean(event$west, event$east)
    #return(c(lat, lon))#event$lat, event$lng input$map_center["lat"], input$map_center["lng"]
    #print(paste0("map center - lat: ", lat, ", lon: ", lon))
    #print(lat, lon)
    #return(center_coor)
  })
  #print(center_coor)
  
  #click_coor <- eventReactive(input$map_click, {# doesn't work with eventReactive
   # cbind(input$map_click[1], input$map_click[2])#click_coor <- c
    #cbind(input$map_click[1], input$map_click[2])
    #click <- input$map_click
    #print(paste0("click is: ", click[1]))
    #lat <- click$lat
    #lon <- click$lng
    #print(paste0("click - lat: ", lat, ", lon: ", lon))
  #}, ignoreNULL = FALSE)
  
  
  # some things that work:
  center_coor <- observeEvent(input$map_center, {
    event <- input$map_center
    lat <- event$lat
    lon <- event$lng
    print(cbind(lat, lon))
  })
  
  points <- eventReactive(input$recalc, {
    cbind(rnorm(40) * 2 + 13, rnorm(40) + 48)
  }, ignoreNULL = FALSE)
  
  # map
  output$map <- renderLeaflet({
    
        #leaflet() %>%
      # addProviderTiles(providers$Stamen.TonerLite,
      #                 options = providerTileOptions(noWrap = TRUE)) %>%
      
    
    
    leaflet() %>%
      addTiles() %>% # insert this in the parenthesis: attribution = 'By Rebecca Schade and Sophia Karlson'
      addControl("Queer Travel Map", position = "topleft", className="map-title") %>% # make this bigger!
      addProviderTiles("Esri.WorldTopoMap", group = "Topographic") %>%
      addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
      
      # add center marker
      #addMarkers(data = center_coor) %>% #lng = lon, lat = lat) %>% 
      
      addCircleMarkers(data = safespace_crs,
                       opacity = 0.5, color = "black", stroke = TRUE,
                       fillOpacity = 0.5, weight=2, fillColor = "purple",
                       popup = paste0("Name: ", test_data$name,
                                      "<br> Type: ", test_data$amenity,
                                      "<br> Website: ", test_data$website,
                                      "<br> Opening hours: ", test_data$opnng_h), #,
                       # if we had the data, these could be added as well:
                       #"<br> Address: ", test_data$address),
                       # who it is for (only men, everyone etc)
                       group = "Safe spaces",#if we don't want the user to be able to not see all the safe spaces, cut this
                       #) %>%
                       clusterOptions = markerClusterOptions()) %>%
      
      # add density overlay here - e.g. polygons like here:
      addPolygons(data = safe_ch,
                  fill = T, weight = 2, color = "purple",
                  popup = paste0("This is a gayborhood!"), 
                  group = "Gayborhoods") %>%
      
      addEasyButton(
        easyButton(
          position = "topleft",
          icon = "fa-crosshairs",
          title = "Locate Me",
          onClick = JS("
            function(btn, map) {
              Shiny.onInputChange('my_easy_button', 'clicked');
            }"
          )
          #onClick = JS(
           # c(
            #  "function(btn,  map){
             #   map.locate({
              #  setView:true,enableHighAccuracy: true,
               # L.circle(event.latlng, event.accuracy).addTo(map);
                #    var Test = L.popup().
                 #       setContent('Your Location').
                  #      setLatLng(event.latlng).addTo(map)
                #})
              #}"
            #)
          #)
            #map.addLayer(addMarkers);
          
        )
      ) %>% 
      

      addMarkers(
        #data = points,
        lng = 12.5224416,#center_coor[1], mean(event$north, event$south),#click_coor[1]
        lat = 55.6852398,#center_coor[1],click_coor[1]
        # if we want another icon, we can use makeIcon https://rstudio.github.io/leaflet/markers.html 
        popup = paste("You are here!"), 
        group = "My location") %>% 
      
      addMeasure(
        position = "topleft",
        primaryLengthUnit = "meters",
        primaryAreaUnit = "sqmeters",
        activeColor = "#3D535D",
        completedColor = "#7D4479",
        localization = "en") %>% 
    
    # do the control stuff
      addLayersControl(
        baseGroups = c("Topographic","Aerial"),
        overlayGroups = c("Safe spaces", "Gayborhoods", "My location"),
        options = layersControlOptions(collapsed = T))
  })
  
}

shinyApp(ui,server)
```


To do:
- make density overlay - as convex hulls around areas with more than x points in y radius from eachother
- how to add overlay and do the groups thing: https://rstudio.github.io/leaflet/showhide.html 
- add legend (but that depends on the kind of density map)

try out bounding boxes

for later: 
- add legend
- better title
- fix NA's? 

center cross, pop-up marker for the nearest one (incl distance to it)
- or find nearest safe space to each chosen location (so not always center)




TEST STUFF

```{r}

# other things to maybe add:
  #addMiniMap(tiles = esri[[1]], toggleDisplay = TRUE,
   #          position = "bottomright"))

  #addLegend("bottomright", pal = pal, values = ~gdp_md_est,
   #   title = "Safe spaces",
    #  labFormat = labelFormat(prefix = "$"),
     # opacity = 1
    #))
    

tag.map.title <- tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 28px;
  }
"))

title <- tags$div(
  tag.map.title, HTML("Map title")
)  

rr <- tags$div(
   HTML('<a href="https://cran.r-project.org/"> <img border="0" alt="ImageTitle" src="/PathToImage/ImageR.jpeg" width="300" height="100"> </a>')
 )  

```


```{r}
# test europe with Layers
leaflet() %>% 
  addTiles() %>% 
  setView( lng = 12.57, lat = 55.68, zoom = 5 ) %>% # view set to cosy bar in CPH
  addProviderTiles("Esri.WorldPhysical", group = "Physical") %>% 
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>% 
  addProviderTiles("MtbMap", group = "Geo") %>% 

addLayersControl(
  baseGroups = c("Geo","Aerial", "Physical"),
  options = layersControlOptions(collapsed = T))


plot(test_data$geometry, pch = 2)
```

```{r}
coor <- test_data$geometry

coor

longitude <- c()

for (i in test_data){
  longitude <- str_replace_all(test_data$geometry, "c(|,[:digit:])", "'")
} 
  
test_data$longitude <- str_replace_all(test_data$geometry, "c\\(| |\\)", "")


test_data$longitude <- str_replace_all(test_data$longitude, "[[:alnum:]\\.],", "")

```
[:digit:].[:digit:]
[:xdigit:].[:xdigit:]


```{r}
# Make buffer of 5 km. Check the units of your object to correctly assign value to dist
safe_space_1km<- st_buffer(st_geometry(safespace_crs), dist = 0.1) # I use the object cities_sf3035 and set the distance to 5000, as I assume the radius measured in meters
plot(safe_space_1km)


safe_ch <- st_convex_hull(st_union(safespace_crs))
plot(safe_ch)
class(safe_ch)

st_crs(safe_ch)
st_crs(safe_space_1km)

safe_it <- st_intersection(safe_ch, safe_space_1km$geometry) # I use the geometry of safe_space_1km

??st_intersection()

# Dissolve the buffers into a single MULTIPOLYGON buffer feature
safe_buff <- st_union(safe_it)



c_buff <- st_transform(c_buff, crs = "+proj=longlat +datum=WGS84")

```

```{r}
library(shiny)
library(leaflet)

ui <- fluidPage(titlePanel("Miles Per Gallon"), leafletOutput("map"))


server <- function(input, output, session) {

 output$map <- renderLeaflet({
 leaflet() %>%
  addProviderTiles(providers$Stamen.TonerLite,
                   options = providerTileOptions(noWrap = TRUE)) %>%

  addEasyButton(
    easyButton(
      position = "topleft",
      icon = "fa-crosshairs",
      title = "Locate Me",
      onClick = JS(
        c(
          "function(btn,  map){map.locate({setView:true,enableHighAccuracy: true })}"
        )
      )
    )
      )
  })
}

shinyApp(ui,server)
```

```{r}
# NOT RUN {
# !formatR
library(shiny)
app <- shinyApp(
  ui = fluidPage(titlePanel("LGBTQ+ Travel Map"), leafletOutput('myMap')),
  server = function(input, output) {
    map = leaflet() %>% addTiles() %>% setView(-93.65, 42.0285, zoom = 17)
    output$myMap = renderLeaflet(map)
  }
)

# }
# NOT RUN {
if (interactive()) app
# }
```

```{r}
# NOT RUN {
leaf <- leaflet() %>%
  addTiles() %>%
  # central park
  fitBounds( -73.9, 40.75, -73.95, 40.8 ) %>%
  addMeasure()

leaf

# customizing
leaf %>% addMeasure(
  position = "bottomleft",
  primaryLengthUnit = "meters",
  primaryAreaUnit = "sqmeters",
  activeColor = "#3D535D",
  completedColor = "#7D4479",
  localization = "de"
)

# }
```

```{r}
library(shiny)
library(leaflet)

r_colors <- rgb(t(col2rgb(colors()) / 255))
names(r_colors) <- colors()

ui <- fluidPage(
  leafletOutput("mymap"),
  p(),
  actionButton("recalc", "New points")
)

server <- function(input, output, session) {

  points <- eventReactive(input$recalc, {
    cbind(rnorm(40) * 2 + 13, rnorm(40) + 48)
  }, ignoreNULL = FALSE)

  output$mymap <- renderLeaflet({
    leaflet() %>%
      addProviderTiles(providers$Stamen.TonerLite,
        options = providerTileOptions(noWrap = TRUE)
      ) %>%
      addMarkers(data = points()) %>% 
    
      addControlGPS(options = gpsOptions(position = "topleft", activate = TRUE, 
                                               autoCenter = TRUE, maxZoom = 10, 
                                               setView = TRUE)) %>% 
      #activateGPS(mymap)
      
      JS(
        c(
          "var geojsonlayer = L.geoJson(geojsondata).addTo(map);
          
          searchIndex = leafletKnn(geojsonlayer);
          
          map.on('click', function(ev){
  
            var nearestResult = searchIndex.nearest(ev.latlng, 1)[0];
          
      
            console.log('nearest lat: ', nearestResult.lat);
            console.log('nearest lng: ', nearestResult.lon);
          
    
            nearestResult.layer.bindPopup('I'm nearest to where you clicked!').openPopup();
          
          })"
        )
      )
  })
}

shinyApp(ui, server)
```

```{r}
library(shiny)
library(leaflet)

r_colors <- rgb(t(col2rgb(colors()) / 255))
names(r_colors) <- colors()

ui <- fluidPage(
  leafletOutput("mymap")
)

server <- function(input, output, session) {

  observeEvent(input$my_easy_button, {
    str(input$my_easy_button)
  })

  output$mymap <- renderLeaflet({
    leaflet() %>% 
      addTiles() %>%
      addMarkers(data=quakes,
        clusterOptions = markerClusterOptions(),
        clusterId = "quakesCluster") %>%
      addEasyButton(easyButton(
        states = list(
          easyButtonState(
            stateName="unfrozen-markers",
            icon="ion-toggle",
            title="Freeze Clusters",
            onClick = JS("
              function(btn, map) {
                var clusterManager =
                  map.layerManager.getLayer('cluster', 'quakesCluster');
                clusterManager.freezeAtZoom();
                btn.state('frozen-markers');
                Shiny.onInputChange('my_easy_button', 'frozen');
              }")
          ),
          easyButtonState(
            stateName="frozen-markers",
            icon="ion-toggle-filled",
            title="UnFreeze Clusters",
            onClick = JS("
              function(btn, map) {
                var clusterManager =
                  map.layerManager.getLayer('cluster', 'quakesCluster');
                clusterManager.unfreeze();
                btn.state('unfrozen-markers');
                Shiny.onInputChange('my_easy_button', 'free');
              }")
          )
        )
      ))
  })
}

shinyApp(ui, server)

```

```{r}
library(leaflet)
library(leaflet.extras)

test_map_2 <- leaflet() %>% addTiles()

test_map_2 <- addControlGPS(new_map, options = gpsOptions(position = "topleft", activate = TRUE, 
                                               autoCenter = TRUE, maxZoom = 10, 
                                               setView = TRUE))
activateGPS(test_map_2)
saveWidget(test_map_2, "test_map_2.html", selfcontained = TRUE)
```

```{r}
library(leaflet)
library(leaflet.extras)
library(shiny)

ui <- fluidPage(
  leafletOutput('map')
)

server <- function(input, output, session) {
  output$map <- renderLeaflet({ leaflet()%>%addTiles() %>% 
      addControlGPS(options = gpsOptions(position = "topleft", activate = TRUE, 
                                         autoCenter = TRUE, maxZoom = 60, 
                                         setView = TRUE))})
      #addMarkers(data = input$map_gps_located)
  observe(
    print(paste0("map center - lat: ", input$map_gps_located$coordinates$lat, ", lon: ", input$map_gps_located$coordinates$lng))
  )
}

shinyApp(ui, server)
```


```{r}
ui <- fluidPage(
  leafletOutput('map')
)

server <- function(input, output, session) {
# code to load the park card once the click event on a marker is intercepted 
 observeEvent(input$parksMap_marker_click, { 
   pin <- input$parksMap_marker_click
   #print(Sys.time()) #uncomment to log coords
   #print(pin) #uncomment to log coords
   selectedPoint <- reactive(parks[parks$Latitude == pin$lat & parks$Longitude == pin$lng,])
   leafletProxy("parksMap", data = selectedPoint()) %>% clearPopups() %>% 
   addPopups(~Longitude,
             ~Latitude,
             popup = ~park_card(selectedPoint()$ParkName, selectedPoint()$ParkCode, selectedPoint()$State, selectedPoint()$Acres, selectedPoint()$Latitude, selectedPoint()$Longitude)
   )
 })
  
}

shinyApp(ui,server)
```



```{r}
library(shiny)
library(leaflet)

ui <- fluidPage(
  titlePanel("LGBTQ+ Travel Map"), 
  leafletOutput("map"))


server <- function(input, output, session) {

  output$map <- renderLeaflet({
    
    leaflet() %>%
      addTiles() %>%
      addControl("Queer Travel Map", position = "topleft", className="map-title") %>% #
      addProviderTiles("Esri.WorldTopoMap", group = "Topographic") %>%
      addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
      
      addCircleMarkers(data = safespace_crs,
                       opacity = 0.5, color = "black", stroke = TRUE,
                       fillOpacity = 0.5, weight=2, fillColor = "purple",
                       popup = paste0("Name: ", test_data$name,
                                      "<br> Type: ", test_data$amenity,
                                      "<br> Website: ", test_data$website,
                                      "<br> Opening hours: ", test_data$opnng_h), #,
                          group = "Safe spaces",
                       
                       clusterOptions = markerClusterOptions()) %>%
      

      addEasyButton(
        easyButton(
          position = "topleft",
          icon = "fa-crosshairs",
          title = "Locate Me",
          onClick = JS("
            function(btn, map) {
              Shiny.onInputChange('my_easy_button', 'clicked');
            }"
    
          )
        )
      ) %>% 
      
      addMeasure(
        position = "topleft",
        primaryLengthUnit = "meters",
        primaryAreaUnit = "sqmeters",
        activeColor = "#3D535D",
        completedColor = "#7D4479",
        localization = "en") %>% 
  
      addLayersControl(
        baseGroups = c("Topographic","Aerial"),
        overlayGroups = c("Safe spaces", "Gayborhoods", "My location"),
        options = layersControlOptions(collapsed = T)) %>% 
      
      addControlGPS(
        options = gpsOptions(position = "topleft", 
        activate = TRUE, 
        autoCenter = TRUE, maxZoom = 10, 
        setView = TRUE))
  })
  
  # code to load the park card once the click event on a marker is intercepted 
  #observe({ #observeEvent input$map_gps_located,
    #event <- input$map_gps_located
    #lat <- input$map_gps_located$coordinates$lat
    #lon <- input$map_gps_located$coordinates$lng
     #print(Sys.time()) #uncomment to log coords
     #print(pin) #uncomment to log coords
    #selectedPoint <- reactive(input$map_gps_located$coordinates$lat, input$map_gps_located$coordinates$lng)
    #leafletProxy("map", data = selectedPoint()) %>% clearPopups() %>% addMarkers() %>% 
     # addPopups("Here are you")#
     #(~Longitude,
      #         ~Latitude,
       #        popup = ~park_card(selectedPoint()$ParkName, selectedPoint()$ParkCode, selectedPoint()$State, selectedPoint()$Acres, selectedPoint()$Latitude, selectedPoint()$Longitude)
     
  #}) 
  observe(
    print(paste0("map center - lat: ", input$map_gps_located$coordinates$lat, ", lon: ", input$map_gps_located$coordinates$lng))
  )
  
  observe({
    
    event <- input$map_gps_located
    if (is.null(event))
      return()

    #isolate({
    #  showZipcodePopup(event$id, event$lat, event$lng)
    leafletProxy("map") %>% clearPopups() %>% addMarkers(
      lng = event$coordinates$lng,
      lat = event$coordinates$lat) %>% 
      addPopups(
        lng = event$coordinates$lng,
        lat = event$coordinates$lat, "Here are you")
  })
 
}

shinyApp(ui,server)
```
for making the nearest safe space pop up https://github.com/rstudio/shiny-examples/blob/master/063-superzip-example/server.R

this works:

  observe({
    
    event <- input$map_gps_located
    if (is.null(event))
      return()

    leafletProxy("map") %>% clearPopups() %>% addMarkers(
      lng = event$coordinates$lng,
      lat = event$coordinates$lat) %>% 
      addPopups(
        lng = event$coordinates$lng,
        lat = event$coordinates$lat, "Here are you")
  })